# 3.PCE.10: Deployment

## Get an EC2 Instance

Use an old Amazon EC2 Instance or create a new one following instructions in [2.11: AWS Deployment](../../2-back-end-basics/2.11-aws-deployment.md).

## Update Postgres Connection Configs for Remote Deployment

We need to run our servers on port 80 for HTTP. Alter the `PORT` variable to change according to `process.argv`.

**index.js**

```javascript
const PORT = process.argv[2];

// ...
```

The following should run without errors on the command line.

```text
node index.js 3004
```

Alter your database configs to include `user` and `password` attributes.

**index.js**

```javascript
// create separate DB connection configs for production vs non-production environments.
// ensure our server still works on our local machines.
let pgConnectionConfigs;
if (process.env.PRODUCTION == true) {
  // determine how we connect to the remote Postgres server
  pgConnectionConfigs = {
    user: 'postgres',
    // set DB_PASSWORD as an environment variable for security.
    password: process.env.DB_PASSWORD,
    host: 'localhost',
    database: 'birding',
    port: 5432,
  };
} else {
  // determine how we connect to the local Postgres server
  pgConnectionConfigs = {
    user: '<MY_UNIX_USERNAME>',
    host: 'localhost',
    database: 'birding',
    port: 5432,
  };
}

// ...
```

## AWS Configs

Log into your instance using SSH.

### Install Postgres

```text
sudo apt update
sudo apt upgrade
sudo apt install build-essential
sudo apt install postgresql
sudo apt install postgresql-client
```

Set the Postgres server to start in the background:

```text
sudo service postgresql start
```

Enter `psql` as the root `postgres` user

```text
sudo -u postgres psql
```

Set a password for the `postgres` user. Record the password to use it below.

```sql
ALTER USER postgres PASSWORD 'newPassword';
```

```sql
ALTER USER postgres PASSWORD '<MY_SECRET_PASSWORD>';
```

Restart Postgres to get the new configs:

```text
sudo service postgresql restart
```

Exit out of the postgres user.

```text
exit
```

## Get the App

Clone the app into your EC2 instance:

```text
git clone <URL_TO_YOUR BIRDING_CLONE>
```

Create the database and the tables:

```text
sudo su - postgres createdb birding
sudo su - postgres psql -d birding -f init_tables.sql
```

Test it:

```text
psql
```

### Run Your App

```
sudo DB_PASSWORD='<MY_SECRET_PASSWORD>' node index.js 80
```

Does your app already depend on the database having data in it? There could be errors if your app expects data to be there at the start. Remember to record this data in a [SQL file.](../3.5-sql-applications/3.5.7-database-setup.md)
