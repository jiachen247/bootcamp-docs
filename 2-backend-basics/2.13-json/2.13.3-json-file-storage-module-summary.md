# 2.13.3: JSON File Storage Module - Summary

## Introduction

In [2.13.2: JSON File Storage Module - Passing Callbacks](2.13.2-json-file-storage-module-passing-callbacks.md) we learned how to abstract repeated code into `jsonFileStorage` such that the callback functions we pass to it contain only the custom logic required by each client app. Below is the transformed code for `jsonFileStorage` that receives callbacks from client apps and handles boilerplate JSON file reading and writing code.

## Final JSON File Storage Module

The following is a summary of our modifications from the previous module. We have also made a few additional edits.

1. The callback passed to `write`, `read`, and `add` functions now accepts 2 params instead of 1. In addition to the JSON content JS Object, the callback accepts an optional 2nd parameter which is the read or write error, allowing the client app to handle the error in their own custom way. For example, each app or feature may wish to have its own distinct popup style or error message.
2. The `add` function now adds an element to an array at a specified `key`, instead of adding a new key-value pair to the JSON. We made this change because the add-to-array functionality is more common than the add-new-key functionality.
   1. At first glance we may feel `add` is overly specific for the generic `jsonFileStorage` module. However, the functionality is common enough that we felt it deserves its own function in the generic module.

#### jsonFileStorage.js

```javascript
import { readFile, writeFile } from 'fs';

/**
 * Add a JS Object to an array of Objects in a JSON file
 * @param {string} filename - Name of JSON file
 * @param {object} jsonContentObj - The content to write to the JSON file
 * @param {function} callback - The callback function to execute on error or success
 *                              Callback takes JS Object as 1st param and write error as 2nd param.
 * @returns undefined
 */
export function write(filename, jsonContentObj, callback) {
  
  // Convert content object to string before writing
  const jsonContentStr = JSON.stringify(jsonContentObj);
  
  // Write content to DB
  writeFile(filename, jsonContentStr, (writeErr) => {
    if (writeErr) {
      console.error('Write error', jsonContentStr, writeErr);
      // Allow each client app to handle errors in their own way
      callback(null, writeErr);
      return;
    }
    console.log('Write success!');
    // Call client-provided callback on successful write
    callback(jsonContentStr, null);
  });
}

/**
 * Add a JS Object to an array of Objects in a JSON file
 * @param {string} filename - Name of JSON file
 * @param {function} callback - The callback function to execute on error or success
 *                              Callback takes JS Object as 1st param and read error as 2nd param.
 * @returns undefined
 */
export function read(filename, callback) {

  const handleFileRead = (readErr, jsonContentStr) => {
    if (readErr) {
      console.error('Read error', readErr);
      // Allow client to handle error in their own way
      callback(null, readErr);
      return;
    }
    
    // Convert file content to JS Object
    const jsonContentObj = JSON.parse(jsonContentStr);
    
    // Call client callback on file content
    callback(jsonContentObj, null);
  };
  
  // Read content from DB
  readFile(filename, 'utf-8', handleFileRead);
}

/**
 * Add a JS Object to an array of Objects in a JSON file
 * @param {string} filename - Name of JSON file
 * @param {string} key - The key in the JSON file whose value is the target array
 * @param {string} input - The value to append to the target array
 * @param {function} callback - The callback function to execute on error or success
 *                              Callback takes JS Object as 1st param and read or write error as 2nd param.
 * @returns undefined
 */
export function add(filename, key, input, callback) {

  const handleFileRead = (readErr, jsonContentStr) => {
    if (readErr) {
      console.error('Read error', readErr);
      callback(null, readErr);
      return;
    }

    // Parse file content into JS Object
    const jsonContentObj = JSON.parse(jsonContentStr);

    // If key does not exist in DB, exit
    if (!(key in jsonContentObj)) {
      // Call callback with relevant error message to let client handle
      callback(null, "Key doesn't exist");
      return;
    }

    // Add input element to target array
    jsonContentObj[key].push(input);

    // Convert JS Object back to string for writing
    const updatedJsonContentStr = JSON.stringify(jsonContentObj);

    // Write updated content to DB
    writeFile(filename, updatedJsonContentStr, (writeErr) => {
      if (writeErr) {
        console.error('Error writing', updatedJsonContentStr, writeErr);
        callback(null, writeErr);
        return;
      }
      console.log('Write success!');
      // Call callback with updated JSON content Object
      callback(jsonContentObj, null);
    });
  };

  // Read existing content from DB
  readFile(filename, 'utf-8', handleFileRead);
}
```

## Example

If data.json looks like this:

```javascript
{
  "people" : []
}
```

For a command like this:

```javascript
node index.js add kai '435 Jalan Bukit Merah'
```

This code will add the person object into the array.

```javascript
import { add } from './jsonFileStorage.js';

if (process.argv[2] === 'add') {
  const name = process.argv[3];
  const address = process.argv[4];

  const person = {
    name: name,
    address: address,
  };

  add('data.json', 'people', person, (data) => {
    console.log('Done', data);
  });
}
```

## More than Add

If we want to do operation other than just add something to an array we have to call read and then write.

Note that this code is more compact - an improvement over the version we were writing before using the module.

```javascript
import { read, write } from './jsonFileStorage.js';

read('data.json', (data) => {
  // Operate on data here
  data['people'][0].name = 'Kai2';

  write('data.json', data, (doneData) => {
    console.log('Done!');
  });
});
```

