# 2.13.3: JSON File Storage Module - Summary

## Introduction

Here is the final version of the JSON file reading module.

### jsonFileStorage.js

```javascript
import { readFile, writeFile } from 'fs';

/**
 * Add a JS Object to an array of Objects in a JSON file
 * @param {string} filename - Name of JSON file
 * @param {object} jsonContentObj - The content to write to the JSON file
 * @param {function} callback - The callback function to execute on error or success
 *                              Callback takes JS Object as 1st param and write error as 2nd param.
 * @returns undefined
 */
export function write(filename, jsonContentObj, callback) {
  const jsonContentStr = JSON.stringify(jsonContentObj);
  writeFile(filename, jsonContentStr, (writeErr) => {
    if (writeErr) {
      console.error('Write error', jsonContentStr, writeErr);
      callback(null, writeErr);
      return;
    }
    console.log('Success!');
    callback(jsonContentStr, null);
  });
}

/**
 * Add a JS Object to an array of Objects in a JSON file
 * @param {string} filename - Name of JSON file
 * @param {function} callback - The callback function to execute on error or success
 *                              Callback takes JS Object as 1st param and read error as 2nd param.
 * @returns undefined
 */
export function read(filename, callback) {
  const handleFileRead = (readErr, jsonContentStr) => {
    if (readErr) {
      console.error('Reading error', readErr);
      callback(null, readErr);
      return;
    }
    const jsonContentObj = JSON.parse(jsonContentStr);
    callback(jsonContentObj, null);
  };
  readFile(filename, 'utf-8', handleFileRead);
}

/**
 * Add a JS Object to an array of Objects in a JSON file
 * @param {string} filename - Name of JSON file
 * @param {string} key - The key in the JSON file whose value is the target array
 * @param {string} input - The value to append to the target array
 * @param {function} callback - The callback function to execute on error or success
 *                              Callback takes JS Object as 1st param and read or write error as 2nd param.
 * @returns undefined
 */
export function add(filename, key, input, callback) {
  const handleFileRead = (readErr, jsonContentStr) => {
    if (readErr) {
      console.error('Read error', readErr);
      callback(null, readErr);
      return;
    }

    // Parse JSON content str into JS Object
    const jsonContentObj = JSON.parse(jsonContentStr);

    // If key doesn't exist in JSON, exit function
    if (!(key in jsonContentObj)) {
      // Call callback with relevant error message
      callback(null, "key doesn't exist");
      return;
    }

    // Add input element to target array
    jsonContentObj[key].push(input);

    // Convert JS Object back to string for writing
    const updatedJsonContentStr = JSON.stringify(jsonContentObj);

    writeFile(filename, updatedJsonContentStr, (writeErr) => {
      if (writeErr) {
        console.error('Error writing', updatedJsonContentStr, writeErr);
        callback(null, writeErr);
        return;
      }
      console.log('Success!');
      // Call callback with updated JSON content Object
      callback(jsonContentObj, null);
    });
  };

  readFile(filename, 'utf-8', handleFileRead);
}
```

We built an add function that is focused around one thing: adding an object to an array, at a key we specify.

We want to use this `jsonFileStorage` library as a generic set of functions to manipulate our `data.json` file, and it may seem overly specific to have a function that only adds an object to an array. However, we'll see that in our web applications that one of the main data formats we deal with fits into an array of objects.

## Example

If data.json looks like this:

```javascript
{
  "people" : []
}
```

For a command like this:

```javascript
node index.js add kai '435 Jalan Bukit Merah'
```

This code will add the person object into the array.

```javascript
import { add } from './jsonFileStorage.js';

if (process.argv[2] === 'add') {
  const name = process.argv[3];
  const address = process.argv[4];

  const person = {
    name: name,
    address: address,
  };

  add('data.json', 'people', person, (data) => {
    console.log('Done', data);
  });
}
```

## More than Add

If we want to do operation other than just add something to an array we have to call read and then write.

Note that this code is more compact - an improvement over the version we were writing before using the module.

```javascript
import { read, write } from './jsonFileStorage.js';

read('data.json', (data) => {
  // Operate on data here
  data['people'][0].name = 'Kai2';

  write('data.json', data, (doneData) => {
    console.log('Done!');
  });
});
```

