# 5.2.2: AJAX Cards

## Introduction

This module demonstrates how we might implement a card game using AJAX and a backend server. This is a pre-cursor to [5.POCE.3: AJAX Cards](../5.poce-post-class-exercises/5.poce.3-ajax-cards.md) and [Project 3: Full-Stack Game](../../projects/project-3-full-stack-game.md). In 5.POCE.3 we we will implement High Card with AJAX, and in Project 3 we will implement a game of your choice using AJAX and other technologies from modules so far.

## Differences From SWE101 Card Games

### Data Persistence

In SWE101 we created card games where the game state would disappear and reset when the user refreshed the page. Since we've learned backend technologies in SWE1, we can use our backend server and database to persist game state across page refreshes. 

### Responses with Selective Data

In SWE101 players could open the browser console and see all cards in the deck or other players' hands by logging the relevant variables. Since learning backend technologies in SWE1, because we store game state server-side, we can prevent cheating by only sending what a player is supposed to see to that player's browser, and not the entire game state.

## Starter Code Repo: `cards-ajax-swe1`

Please find the starter repo `cards-ajax-swe1` [here](https://github.com/rocketacademy/cards-ajax-swe1). Feel free to navigate to the relevant files in GitHub while reading the following sections.

## Migrations

The starter code contains 1 migration to generate the `Games` table.

Note the `cards` attribute's data type on line 12: JSON. We can use the JSON data type to break the rule of not storing data structures in a table cell. This is for the following reasons.

1. We want to store data representing a standard deck of cards. It will be easier to store the cards in a JSON column than to keep joining across multiple tables to perform simple operations such as dealing or playing cards. For card games with less conventional or even unlimited cards, we may want to revisit this decision and store cards in their own table.
2. We do not need to query for card deck data across games. For example, in our current game we would probably not query for all games where a player drew an Ace. Thus it is ok to store card data in JSON where it might be less accessible for queries across records.

#### **20201221183525-create-games-table.js** 

The following migration code is available the repo [here](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/migrations/20201221183525-create-games-table.js#L12).

```javascript
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('Games', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      cards: {
        // allow us to keep non-relational data for the cards
        type: Sequelize.JSON,
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
    });
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable('Games');
  },
};
```

## Game Creation Logic

Game creation logic spans the frontend and backend. 

### Frontend

The frontend components of game creation live in `public/script.js`. When the page loads we display a "Create Game" button. When the user clicks this button we'll create a single game in the database. The following code is available in the repo [here](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js#L45-L78).

#### `script.js`

```javascript
const createGame = function () {
  // Make a request to create a new game
  axios.post('/games')
    .then((response) => {
      // set the global value to the new game.
      currentGame = response.data;

      console.log(currentGame);

      // display it out to the user
      runGame(currentGame);

      // for this current game, create a button that will allow the user to
      // manipulate the deck that is on the DB.
      // Create a button for it.
      const dealBtn = document.createElement('button');
      dealBtn.addEventListener('click', dealCards);

      // display the button
      dealBtn.innerText = 'Deal';
      document.body.appendChild(dealBtn);
    })
    .catch((error) => {
      // handle error
      console.log(error);
    });
};

// manipulate DOM, set up create game button
createGameBtn.addEventListener('click', createGame);
createGameBtn.innerText = 'Create Game';
document.body.appendChild(createGameBtn);
```

### Backend

The backend components of game creation logic primarily live in the Games Controller. The controller's `create` function [creates a new game record using Sequelize](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L124). When creating a new game record, we also [create and shuffle a new deck](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L113) and save it in the game record. The game controller has [card and deck logic helper functions](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L1-L89) from previous modules. The following code is available in the repo [here](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L110-L134). 

#### `games.mjs`

```javascript
// create a new game. Insert a new row in the DB.
const create = async (request, response) => {
  // deal out a new shuffled deck for this game.
  const cardDeck = shuffleCards(makeDeck());
  const playerHand = [cardDeck.pop(), cardDeck.pop()];

  const newGame = {
    cardDeck,
    playerHand,
  };

  try {
    // run the DB INSERT query
    const game = await db.Game.create(newGame);

    // send the new game back to the user.
    // dont include the deck so the user can't cheat
    response.send({
      id: game.id,
      playerHand: game.playerHand,
    });
  } catch (error) {
    response.status(500).send(error);
  }
};
```

## Game Running Logic

The response from the AJAX game creation request contains the , it displays the hand the server dealt using the `runGame` function.

[https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js\#L8](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js#L8)

When a game is created in the database, a deal cards button is created.

### `script.js` `dealCards`

[https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js\#L28](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js#L28)

When the user clicks the `Deal` button, a PUT request is made to the server. This request will alter the cards in the game and respond with two new cards dealt from the deck.

### Deal Controller

[https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs\#L145](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L145)

The deal controller gets a game id in the request. It uses that to find the game, deal two new cards into the player hand object, update that in the database and send back the two new cards. Note that the player in the browser has never seen the order of the deck, so they cannot cheat.

## Exercise

Add functionality in the server that evaluates if the user has "won" by drawing any card \(of the two\) that was higher than the last pair. Send that information back in the response to the request.

