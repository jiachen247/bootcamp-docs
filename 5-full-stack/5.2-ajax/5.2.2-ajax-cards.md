# 5.2.2: AJAX Cards

## Introduction

This module demonstrates how we might implement a card game using AJAX and a backend server. This is a pre-cursor to [5.POCE.3: AJAX Cards](../5.poce-post-class-exercises/5.poce.3-ajax-cards.md) and [Project 3: Full-Stack Game](../../projects/project-3-full-stack-game.md). In 5.POCE.3 we we will implement High Card with AJAX, and in Project 3 we will implement a game of your choice using AJAX and other technologies from modules so far.

## Differences From SWE101 Card Games

### Data Persistence

In SWE101 we created card games where the game state would disappear and reset when the user refreshed the page. Since we've learned backend technologies in SWE1, we can use our backend server and database to persist game state across page refreshes. 

### Responses with Selective Data

In SWE101 players could open the browser console and see all cards in the deck or other players' hands by logging the relevant variables. Since learning backend technologies in SWE1, because we store game state server-side, we can prevent cheating by only sending what a player is supposed to see to that player's browser, and not the entire game state.

## Starter Code Repo: `cards-ajax-swe1`

Please find the starter repo `cards-ajax-swe1` [here](https://github.com/rocketacademy/cards-ajax-swe1). Feel free to follow along using the GitHub interface.

## Migrations

The starter code contains 1 migration to generate the `Games` table.

Note the `cards` attribute's data type on line 12: JSON. We can use the JSON data type to break the rule of not storing data structures in a cell. This is for the following reasons.

1. We want to store data representing a standard deck of cards. Using JSON it will be easy to store the entire deck data structure in a table cell, rather than constantly joining across multiple tables to make minor updates to a standard card deck.
2. We do not need to query for card deck data across games. For example, we would probably not query for all games where a player drew an Ace.

The following migration code is available the repo [here](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/migrations/20201221183525-create-games-table.js#L12).

#### **20201221183525-create-games-table.js** 

```javascript
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('Games', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      cards: {
        // allow us to keep non-relational data for the cards
        type: Sequelize.JSON,
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
    });
  },

  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable('Games');
  },
};
```

### `script.js`  `createGame`

[https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js\#L45](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js#L45)

When the page loads we display a "Create Game" button. When the user clicks this button we'll create a single game in the database.

### Create Controller

[https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs\#L115](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L115)

Specifically in the `create` controller we make a new game record using Sequelize.

This controller [has all the card and deck logic inside of it](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L7).

We create and shuffle a new deck, [then save it in the database.](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L129)

### `script.js` `runGame`

[https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js\#L8](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js#L8)

When the browser receives the response to creating a game, it displays the hand the server dealt using the `runGame` function.

When a game is created in the database, a deal cards button is created.

### `script.js` `dealCards`

[https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js\#L28](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/public/script.js#L28)

When the user clicks the `Deal` button, a PUT request is made to the server. This request will alter the cards in the game and respond with two new cards dealt from the deck.

### Deal Controller

[https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs\#L145](https://github.com/rocketacademy/cards-ajax-swe1/blob/main/controllers/games.mjs#L145)

The deal controller gets a game id in the request. It uses that to find the game, deal two new cards into the player hand object, update that in the database and send back the two new cards. Note that the player in the browser has never seen the order of the deck, so they cannot cheat.

## Exercise

Add functionality in the server that evaluates if the user has "won" by drawing any card \(of the two\) that was higher than the last pair. Send that information back in the response to the request.

