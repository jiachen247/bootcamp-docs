# 4.2.6: Sequelize Validations

## Introduction

Sequelize contains functionality so that we can easily specify what kinds of data we want to go in the database.

There are two levels of restrictions we can set, constraints and validations.

## Setup Packages and Folders, Configure DB

Set up Sequelize with a new Node application and configure the DB in the same way we did in [Module 4.2.1: Intro to Sequelize](4.2.1-intro-to-sequelize.md#setup-packages-and-folders). Update `config.js` to use a new DB name, `validations_development` to distinguish the DB from other modules. Stop after creating the DB and follow the steps below to create a one-to-many SQL relationship with through table attributes with Sequelize.

### Migrations: Create Categories and Items Tables

```text
npx sequelize-cli migration:generate --name create-table
```

Replace the contents of the generated file with the following table-creation code.

#### Sample Migration File \(&lt;GENERATED\_DATE&gt;-create-table.js\)

```javascript
module.exports = {
  up: async (queryInterface, Sequelize) => {
    // Categories needs to be created first because Items references Categories
    await queryInterface.createTable('categories', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      name: {
        type: Sequelize.STRING,
      },
      created_at: {
        allowNull: false,
        type: Sequelize.DATE,
      },
      updated_at: {
        allowNull: false,
        type: Sequelize.DATE,
      },
    });

    await queryInterface.createTable('items', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      name: {
        allowNull: false,
        type: Sequelize.STRING,
      },
      category_id: {
        type: Sequelize.INTEGER,
        references: {
          model: 'categories',
          key: 'id',
        },
      },
      created_at: {
        type: Sequelize.DATE,
      },
      updated_at: {
        allowNull: false,
        type: Sequelize.DATE,
      },
    });
  },

  down: async (queryInterface, Sequelize) => {
    // items table needs to be dropped first because items references categories
    await queryInterface.dropTable('items');
    await queryInterface.dropTable('categories');
  },
};
```

Create the `categories` and `items` tables in our DB by running migrations.

```text
npx sequelize-cli db:migrate
```

Verify table creation in `psql`.

```text
psql -d validations_development
```

### Models: Create Category and Item Models

#### models/category.mjs

```javascript
export default function categoryModel(sequelize, DataTypes) {
  return sequelize.define(
    'category',
    {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: DataTypes.INTEGER,
      },
      name: {
        type: DataTypes.STRING,
      },
      createdAt: {
        allowNull: false,
        type: DataTypes.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: DataTypes.DATE,
      },
    },
    {
      // The underscored option makes Sequelize reference snake_case names in the DB.
      underscored: true,
    }
  );
}
```

#### models/item.mjs

```javascript
export default function itemModel(sequelize, DataTypes) {
  return sequelize.define(
    'item',
    {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: DataTypes.INTEGER,
      },
      name: {
        type: DataTypes.STRING,
      },
      categoryId: {
        type: Sequelize.INTEGER,
        references: {
          model: 'categories',
          key: 'id',
        },
      },
      createdAt: {
        allowNull: false,
        type: DataTypes.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: DataTypes.DATE,
      },
    },
    {
      // The underscored option makes Sequelize reference snake_case names in the DB.
      underscored: true,
    }
  );
}
```

#### models/index.mjs

```javascript
import sequelizePackage from 'sequelize';
import allConfig from '../config/config.js';

import itemModel from './item.mjs';
import categoryModel from './category.mjs';

const { Sequelize } = sequelizePackage;
const env = process.env.NODE_ENV || 'development';
const config = allConfig[env];
const db = {};

let sequelize = new Sequelize(
  config.database,
  config.username,
  config.password,
  config
);

db.Item = itemModel(sequelize, Sequelize.DataTypes);
db.Category = categoryModel(sequelize, Sequelize.DataTypes);

db.Item.belongsTo(db.Category);
db.Category.hasMany(db.Item);

db.sequelize = sequelize;
db.Sequelize = Sequelize;

export default db;
```

### Seed: Create Seed Data for DB

Use `sequelize-cli` to generate a seed data migration file.

```text
npx sequelize-cli seed:generate --name seed-data
```

#### Sample Seed Data Migration File \(&lt;GENERATED\_DATE&gt;-seed-data.js\)

The following seed data migration file creates 3 categories, and 3 items that reference each of those categories, i.e. 9 items total. All our added to the DB when the seed migration runs.

```javascript
module.exports = {
  up: async (queryInterface) => {
    const categoriesList = [
      {
        name: 'fish',
        created_at: new Date(),
        updated_at: new Date(),
      },
      {
        name: 'fruit',
        created_at: new Date(),
        updated_at: new Date(),
      },
      {
        name: 'meat',
        created_at: new Date(),
        updated_at: new Date(),
      },
    ];

    // Insert categories before items because items reference categories
    let categories = await queryInterface.bulkInsert(
      'categories',
      categoriesList,
      { returning: true }
    );

    const items = [];
    for (let i = 0; i < categories.length; i++) {
      const category = categories[i];

      items.push({
        name: 'some item',
        category_id: category.id,
        created_at: new Date(),
        updated_at: new Date(),
      });

      items.push({
        name: 'other item',
        category_id: category.id,
        created_at: new Date(),
        updated_at: new Date(),
      });

      items.push({
        name: 'iitemmm',
        category_id: category.id,
        created_at: new Date(),
        updated_at: new Date(),
      });
    }

    await queryInterface.bulkInsert('items', items);
  },

  down: async (queryInterface) => {
    // Delete item before category records because items reference categories
    await queryInterface.bulkDelete('items', null, {});
    await queryInterface.bulkDelete('categories', null, {});
  },
};
```

Run seed migrations.

```javascript
npx sequelize-cli db:seed:all
```

#### create.mjs

```javascript
import db from './models/index.mjs';

db.Category.findOne({
  where: {
    name: [process.argv[2]],
  },
})
  .then((category) => {
    return db.Item.create({
      name: process.argv[3],
      categoryId: category.id,
    });
  })
  .then((item) => {
    console.log(item);
  })
  .catch((error) => {
    console.log(error);
  });
```

## Constraints

Constraints are settings we make when we create the database table. Sequelize will let us know when we violate one of these constraints.

### Allow Null

We have already been telling the database not to allow null values.

Let's make a change to the database so that we don't allow null \(empty\) for the item name, on line 9.

#### &lt;GENERATED\_DATE&gt;-create-table.js

```javascript
await queryInterface.createTable('items', {
  id: {
    allowNull: false,
    autoIncrement: true,
    primaryKey: true,
    type: Sequelize.INTEGER,
  },
  name: {
    allowNull: false,
    type: Sequelize.STRING,
  },
  created_at: {
    allowNull: false,
    type: Sequelize.DATE,
  },
  updated_at: {
    allowNull: false,
    type: Sequelize.DATE,
  },
});
```

When we attempt to violate the constraint we get an error:

```javascript
node create.mjs fish
```

### Error Detection

If we want to write logic for this error, we need to import the error so we can put it in a conditional.

#### create.mjs

```javascript
import sequelizePackage from 'sequelize';
import db from './models/index.mjs';

const { DatabaseError } = sequelizePackage;

db.Category.findOne({
  where: {
    name: [process.argv[2]],
  },
})
  .then((category) => {
    return db.Item.create({
      name: process.argv[3],
      categoryId: category.id,
    });
  })
  .then((item) => {
    console.log(item);
  })
  .catch((error) => {
    if (error instanceof DatabaseError) {
      console.log('SORRY ITS A DATABSE ERROR');
      console.log(error);
    } else {
      console.log(error);
    }
  });
```

{% hint style="warning" %}
Note that normally we would not use `DatabaseError` to catch a null constraint like we did in the first example. This is because `DatabaseError` is also used when a SQL query fails, for example when you misspell the name of a table in the model file. It also does not give you the English-formatted error text as in the validation error example below. Always add validation to models whenever possible, for example in the case of null-checking.
{% endhint %}

### Other Constraint Types

We can write similar constraints and logic for: uniqueness, foreign keys, etc. See more about Sequelize constraints here: [https://sequelize.org/master/manual/validations-and-constraints.html](https://sequelize.org/master/manual/validations-and-constraints.html)

## Validations

In the model we can specify what kind of data we want to allow into the database.

If we want to validate the presence of a field \(in JavaScript\) rather than send a query to the database, we can add the same code to the model file on line 11.

#### models/item.mjs

```javascript
export default function itemModel(sequelize, DataTypes) {
  return sequelize.define(
    'item',
    {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: DataTypes.INTEGER,
      },
      name: {
        type: DataTypes.STRING,
        allowNull: false,
      },
      createdAt: {
        allowNull: false,
        type: DataTypes.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: DataTypes.DATE,
      },
    },
    {
      // The underscored option makes Sequelize reference snake_case names in the DB.
      underscored: true,
    }
  );
}
```

### Error Detection

If we want to write logic for this error, we need to import the error so we can put it in a conditional.

#### create.mjs

```javascript
import sequelizePackage from 'sequelize';
import db from './models/index.mjs';

const { ValidationError } = sequelizePackage;

db.Category.findOne({
  where: {
    name: [process.argv[2]],
  },
})
  .then((category) => {
    return db.Item.create({
      name: process.argv[3],
      categoryId: category.id,
    });
  })
  .then((item) => {
    console.log(item);
  })
  .catch((error) => {
    if (error instanceof ValidationError) {
      console.log('SORRY VALIDATION ERROR!');
      console.log(error);
    } else {
      console.log(error);
    }
  });
```

### Other Validations

Here is an example with more validations on the model:

#### models/item.mjs

```javascript
export default function itemModel(sequelize, DataTypes) {
  return sequelize.define(
    'Item',
    {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: DataTypes.INTEGER,
      },
      name: {
        type: DataTypes.STRING,
        unique: true,
        validate: {
          isAlpha: true, // will only allow letters
          len: [3, 23],
        },
      },
      categoryId: {
        type: Sequelize.INTEGER,
        references: {
          model: 'categories',
          key: 'id',
        },
      },
      createdAt: {
        allowNull: false,
        type: DataTypes.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: DataTypes.DATE,
      },
    },
    {
      // The underscored option makes Sequelize reference snake_case names in the DB.
      underscored: true,
    }
  );
}
```

#### create.mjs

```javascript
import sequelizePackage from 'sequelize';
import db from './models/index.mjs';

const {
  UniqueConstraintError,
  ValidationError,
  DatabaseError,
} = sequelizePackage;

db.Category.findOne({
  where: {
    name: [process.argv[2]],
  },
})
  .then((category) => {
    return db.Item.create({
      name: process.argv[3],
      categoryId: category.id,
    });
  })
  .then((item) => {
    console.log(item);
  })
  .catch((error) => {
    if (error instanceof UniqueConstraintError) {
      console.log('SORRY UNIQUE ERROR');
      console.log(error);
    } else if (error instanceof ValidationError) {
      console.log('SORRY VALIDATION ERROR');
      console.log(error);
      console.log('THIS IS WHAT HAPPENED:');
      console.log(error.errors[0].message);
    } else if (error instanceof DatabaseError) {
      console.log('SORRY DB ERROR');
      console.log(error);
    } else {
      console.log(error);
    }
  });
```

Copy the code and try the following commands:

```javascript
node create.mjs fish some-item
```

```javascript
node create.mjs fish
```

```javascript
node create.mjs fish a
```

```javascript
node create.mjs fish ababababababababababababababababababababababababababababababababababababababababababa
```

### Error Handling

Validation errors are structured so that we can handle errors gracefully. In our example, we could show the user what happened by parsing the data in the error object. Note lines 27 and 28 in `create.mjs`above. This message could be displayed in the form to the user.

#### Sample Errors Object

```javascript
errors: [
  ValidationErrorItem {
    message: 'Validation len on name failed',
    type: 'Validation error',
    path: 'name',
    value: 'h',
    origin: 'FUNCTION',
    instance: [Item],
    validatorKey: 'len',
    validatorName: 'len',
    validatorArgs: [Array],
    original: [Error]
  }
]
```

## Further Reading

See the validation documentation here: [https://sequelize.org/master/manual/validations-and-constraints.html](https://sequelize.org/master/manual/validations-and-constraints.html)

See a full list of possible Sequelize errors here: [https://sequelize.readthedocs.io/en/latest/api/errors/](https://sequelize.readthedocs.io/en/latest/api/errors/)

